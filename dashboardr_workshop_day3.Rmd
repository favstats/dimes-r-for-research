---
title: "dashboardr Workshop - Day 3"
subtitle: "R Package Development from Scratch"
author: '<br><br><br><br>Fabio Votta <br><br> <a href="http://github.com/favstats"><i class="fa fa-github fa-fw"></i>&nbsp;favstats</a> <br> <a href="https://twitter.com/favstats"> <i class="fa fa-twitter fa-fw"></i>&nbsp;@favstats</a> <br> <a href="http://www.favstats.eu/"><i class="fa fa-address-card"></i>&nbsp; www.favstats.eu</a><br> <a href="https://favstats.github.io/dashboardr/"><i class="fa fa-paper-plane fa-fw"></i>&nbsp;favstats.github.io/dashboardr</a> <br><br>`r Sys.Date()`'
output: 
  xaringan::moon_reader:
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
      slideNumberFormat: "%current%<br>"
      ratio: "16:9"
    includes:
      in_header: header.html      
    css: [default, custom.css]
---

<style>
.onehundredtwenty {
  font-size: 120%;
}

.ninety {
  font-size: 90%;
}

.eightyfive {
  font-size: 85%;
}
   
.eighty {
  font-size: 80%;
}
   
.seventyfive {
  font-size: 75%;
}
   
.seventy {
  font-size: 70%;
}
   
.sixty {
  font-size: 60%;
}

.fivty {
  font-size: 50%;
}

.small-code .remark-code {
  font-size: 70%;
}

.tiny-code .remark-code {
  font-size: 60%;
}

.super-tiny-code .remark-code {
  font-size: 55%;
}
</style>

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
knitr::opts_chunk$set(
  warning = FALSE, 
  message = FALSE,
  echo = TRUE,
  eval = FALSE,
  fig.retina = 2,
  comment = "#>"
)
```

### It's normal to struggle at first but it gets better!

```{r, echo = FALSE, eval = TRUE, out.width = "50%", fig.align = "center"}
knitr::include_graphics("https://cdn.myportfolio.com/45214904-6a61-4e23-98d6-b140f8654a40/dbb57803-0c35-4b92-b19f-453d28ef4b20_rw_1920.png?h=8b25ac0adef09e18b3a8d258a7e57b56")
```

.fivty[Illustration by [Allison Horst](https://twitter.com/allison_horst)]

--

+ Package development looks intimidating... but it's actually very approachable!

--

+ The tooling has gotten **so much better** in recent years

--

+ By the end of today, you'll have created your own R package! ğŸ‰

---

class: inverse, center, middle

# Welcome to Day 3!

## R Package Development

![](https://media.giphy.com/media/LmNwrBhejkK9EFP504/giphy.gif)

---

# What We'll Cover Today

.pull-left[
### Part 1: Why Packages?
- Benefits of packaging code
- When to create a package
- Package vs. script mindset

### Part 2: Package Structure
- Essential files and folders
- DESCRIPTION & NAMESPACE
- The R/ folder

### Part 3: Creating Your Package
- `usethis` magic
- Tidy package conventions
- Git & GitHub integration
]

.pull-right[
### Part 4: Documentation
- `roxygen2` basics
- Writing good docs
- Examples that work

### Part 5: Testing
- `testthat` fundamentals
- Writing effective tests
- Test-driven development

### Part 6: Sharing Your Package
- `pkgdown` websites
- CRAN considerations
- Best practices
]

---

class: inverse, center, middle

# Part 1: Why Create a Package?

![](https://media.giphy.com/media/s2qXK8wAvkHTO/giphy.gif)

---

## The Problem with Scripts

.pull-left[
### Sound familiar?

```r
# Load my helper functions
source("helpers.R")
source("utils.R")
source("plotting_functions.R")
source("data_cleaning.R")

# Now I can work...
```

ğŸ˜« Which file has which function?

ğŸ˜« Did I `source()` in the right order?

ğŸ˜« What packages do I need?

ğŸ˜« How do I share this mess?
]

--

.pull-right[
### The Package Solution

```r
library(mypackage)

# Everything just works!
my_function(data)
```

âœ… One `library()` call

âœ… Dependencies handled

âœ… Documentation built-in

âœ… Easy to share & install
]

---

## When Should You Create a Package?

.key-point[
**Rule of thumb:** If you've copy-pasted the same function into 3+ projects, it's time for a package!
]

--

### Great candidates for packages:

.pull-left[
**Data Processing**
- Custom cleaning pipelines
- Domain-specific transformations
- API wrappers

**Analysis**
- Statistical methods
- Machine learning workflows
- Simulation functions
]

.pull-right[
**Visualization**
- Custom ggplot themes
- Specialized chart types
- Report templates

**Utilities**
- File handling helpers
- String manipulation
- Project templates
]

---

## Benefits of Packaging

```{r, eval = FALSE}
                       âŠ‚_ãƒ½
                       ã€€ ï¼¼ï¼¼   Packages
                       ã€€ã€€ ï¼¼( Í¡Â° ÍœÊ– Í¡Â°)
                        ã€€ã€€ã€€ >ã€€âŒ’ãƒ½
                       ã€€ã€€ã€€/ ã€€ ã¸ï¼¼
                       ã€€ã€€ /ã€€ã€€/ã€€ï¼¼ï¼¼give you
                       ã€€ã€€ ï¾šã€€ãƒã€€ã€€ ãƒ½_ã¤
                       ã€€ã€€/ã€€/
                       ã€€ /ã€€/|
                       ã€€(ã€€(ãƒ½
                       ã€€|ã€€|ã€ï¼¼superpowers
                       ã€€| ä¸¿ ï¼¼ âŒ’)
                       ã€€| |ã€€ã€€) /
                       ãƒ )ã€€ã€€Lï¾‰
                       (_ï¼
```

---

## Benefits of Packaging

| Benefit | Why It Matters |
|---------|----------------|
| **Reproducibility** | Same code, same results, anywhere |
| **Documentation** | Help files force you to explain your code |
| **Testing** | Catch bugs before they bite |
| **Dependencies** | Declare what you need, get it automatically |
| **Versioning** | Track changes, roll back if needed |
| **Sharing** | `install_github()` and done! |
| **Community** | Give back, get feedback |

--

<br>

.center[
.analogy[
Think of a package as a **gift-wrapped present** ğŸ â€” everything needed is inside, nicely organized, with instructions included!
]
]

---

class: inverse, center, middle

# Part 2: Package Structure

## What's Inside the Box?

![](https://media.giphy.com/media/xUPGGDNsLvqsBOhuU0/giphy.gif)

---

## Anatomy of an R Package

```
mypackage/
â”œâ”€â”€ DESCRIPTION        # Package metadata (name, version, dependencies)
â”œâ”€â”€ NAMESPACE          # What to export/import (auto-generated)
â”œâ”€â”€ LICENSE.md         # How others can use your code
â”œâ”€â”€ README.md          # Package overview for GitHub
â”œâ”€â”€ R/                 # Your R functions live here!
â”‚   â”œâ”€â”€ function1.R
â”‚   â”œâ”€â”€ function2.R
â”‚   â””â”€â”€ utils.R
â”œâ”€â”€ man/               # Documentation (auto-generated by roxygen2)
â”‚   â”œâ”€â”€ function1.Rd
â”‚   â””â”€â”€ function2.Rd
â”œâ”€â”€ tests/             # Unit tests
â”‚   â”œâ”€â”€ testthat.R
â”‚   â””â”€â”€ testthat/
â”‚       â””â”€â”€ test-function1.R
â””â”€â”€ .Rbuildignore      # Files to exclude from package build
```

---

## The DESCRIPTION File

### The "ID card" of your package

```yaml
Package: mypackage
Title: What the Package Does (One Line, Title Case)
Version: 0.1.0
Authors@R: 
    person("First", "Last", , "email@example.com", 
           role = c("aut", "cre"))
Description: A longer description of what the package does.
    Use multiple lines if needed. Each line should be indented
    with 4 spaces. Describe the main functionality.
License: MIT + file LICENSE
Encoding: UTF-8
Roxygen: list(markdown = TRUE)
RoxygenNote: 7.2.3
Imports: 
    dplyr,
    ggplot2
Suggests: 
    testthat (>= 3.0.0)
```

---

## DESCRIPTION: Key Fields

.pull-left[
### Required Fields

| Field | Purpose |
|-------|---------|
| `Package` | Name (letters, numbers, .) |
| `Title` | One-line description |
| `Version` | Semantic versioning |
| `Authors@R` | Who made this |
| `Description` | What it does |
| `License` | How to use/share |
]

.pull-right[
### Dependency Fields

| Field | When to Use |
|-------|-------------|
| `Imports` | Required packages |
| `Suggests` | Optional packages |
| `Depends` | Rarely needed |
| `LinkingTo` | C/C++ packages |

.tip[
Use `Imports` for packages your functions need.
Use `Suggests` for packages only used in tests/vignettes.
]
]

---

## The NAMESPACE File

### Controls what's visible

```r
# Export functions for users
export(my_function)
export(another_function)

# Import from other packages
importFrom(dplyr,"%>%")
importFrom(dplyr,filter)
importFrom(ggplot2,ggplot)

# Import entire package namespace
import(stringr)
```

--

.warning[
**Don't edit this file manually!**

`roxygen2` generates it automatically from your documentation comments.
]

---

## The R/ Folder

### Where your functions live

.pull-left[
**One function per file** (recommended)
```
R/
â”œâ”€â”€ add.R
â”œâ”€â”€ subtract.R
â”œâ”€â”€ multiply.R
â””â”€â”€ divide.R
```

Easy to find, easy to maintain!
]

.pull-right[
**Related functions together** (also fine)
```
R/
â”œâ”€â”€ arithmetic.R     # add, subtract
â”œâ”€â”€ visualization.R  # plot_*, theme_*
â””â”€â”€ utils.R          # helper functions
```

Group by purpose.
]

--

<br>

.key-point[
**Rule:** Never use `library()` or `source()` in package code!
Instead, use `@import` or `package::function()` syntax.
]

---

class: inverse, center, middle

# Part 3: Creating Your Package

## Let's Build Something!

![](https://media.giphy.com/media/3oKIPnAiaMCws8nOsE/giphy.gif)

---

## The Essential Toolkit

```{r, eval = FALSE}
# Install the holy trinity of package development
install.packages(c("devtools", "usethis", "roxygen2", "testthat"))
```

.pull-left[
```{r, echo = FALSE, eval = TRUE, out.width = "80px"}
knitr::include_graphics("https://usethis.r-lib.org/logo.png")
```

### usethis
Automates package setup and common tasks
]

.pull-right[
```{r, echo = FALSE, eval = TRUE, out.width = "80px"}
knitr::include_graphics("https://devtools.r-lib.org/logo.png")
```

### devtools
Development workflow (build, check, install)
]

---

## Step 1: Choose a Name

### The `available` package helps!

```{r}
install.packages("available")
library(available)

available("myawesomepackage", browse = FALSE)
```

```
â”€â”€ myawesomepackage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Name valid: âœ”
Available on CRAN: âœ” 
Available on Bioconductor: âœ”
Available on GitHub:  âœ” 
```

--

.tip[
**Good package names are:**
- All lowercase
- Memorable and descriptive
- Not already taken
- Easy to type and pronounce
]

---

## Step 1: Choose a Name

.center[

### When your package name is available:

![](https://media.giphy.com/media/l3vR7aXoQX0OdHi48/giphy.gif)

]

---

## Naming Conventions

.pull-left[
### âœ… Good Names

| Name | Why |
|------|-----|
| `dplyr` | Memorable, unique |
| `ggplot2` | Clear purpose |
| `stringr` | Describes functionality |
| `lubridate` | Clever wordplay |
| `tidyr` | Tidy + R |
]

.pull-right[
### âŒ Avoid

| Issue | Example |
|-------|---------|
| Too generic | `tools`, `utils` |
| Taken | `stats`, `base` |
| Hard to spell | `catagorizer` |
| Offensive | ğŸ™ˆ |
| Too long | `myamazingdataprocessingpackage` |
]

---

## Step 2: Create the Package

```{r}
library(usethis)

# Create a minimal package
create_package("~/projects/mypackage")
```

--

### Or use the "tidy" template (recommended!)

```{r}
# Creates package with tidyverse conventions
create_tidy_package("~/projects/mypackage")
```

.key-point[
`create_tidy_package()` sets up:
- MIT license
- README.Rmd
- testthat infrastructure  
- roxygen2 with markdown
- .gitignore
- GitHub-ready structure
]

---

## What Gets Created

```
mypackage/
â”œâ”€â”€ .Rbuildignore
â”œâ”€â”€ .gitignore
â”œâ”€â”€ DESCRIPTION
â”œâ”€â”€ LICENSE
â”œâ”€â”€ LICENSE.md
â”œâ”€â”€ NAMESPACE
â”œâ”€â”€ R/
â”œâ”€â”€ README.Rmd
â”œâ”€â”€ README.md
â”œâ”€â”€ cran-comments.md
â”œâ”€â”€ mypackage.Rproj
â””â”€â”€ tests/
    â”œâ”€â”€ testthat/
    â””â”€â”€ testthat.R
```

--

.center[
ğŸ‰ **Congratulations! You have a valid R package!** ğŸ‰
]

---

## Step 3: Add Git & GitHub

```{r}
# Initialize git repository
use_git()

# Create GitHub repo and push
use_github()
```

--

### Now anyone can install your package!

```{r}
# From GitHub
devtools::install_github("yourusername/mypackage")

# Or using pak (faster!)
pak::pak("yourusername/mypackage")
```

---

class: inverse, center, middle

# Let's Write Our First Function!

![](https://media.giphy.com/media/3oKIPnAiaMCws8nOsE/giphy.gif)

---

## Step 4: Create a Function

```{r}
# Create a new R file in the R/ folder
use_r("greeting")
```

This opens `R/greeting.R` â€” let's add a function:

```{r}
#' Greet a person
#'
#' @param name A character string with the person's name.
#' @param excited Logical. Add exclamation marks? Default FALSE.
#'
#' @return A character string with the greeting.
#' @export
#'
#' @examples
#' greet("World")
#' greet("R User", excited = TRUE)
greet <- function(name, excited = FALSE) {
  msg <- paste0("Hello, ", name)
  if (excited) {
    msg <- paste0(msg, "!!!")
  }
  msg
}
```

---

## Let's Break Down the Documentation

```{r}
{{#' Greet a person}}
#'
#' @param name A character string with the person's name.
#' @param excited Logical. Add exclamation marks? Default FALSE.
#'
#' @return A character string with the greeting.
#' @export
#'
#' @examples
#' greet("World")
#' greet("R User", excited = TRUE)
greet <- function(name, excited = FALSE) {
  ...
}
```

**Title** â€” First line, brief description

---

## Let's Break Down the Documentation

```{r}
#' Greet a person
#'
{{#' @param name A character string with the person's name.}}
{{#' @param excited Logical. Add exclamation marks? Default FALSE.}}
#'
#' @return A character string with the greeting.
#' @export
#'
#' @examples
#' greet("World")
#' greet("R User", excited = TRUE)
greet <- function(name, excited = FALSE) {
  ...
}
```

**@param** â€” Document each argument

---

## Let's Break Down the Documentation

```{r}
#' Greet a person
#'
#' @param name A character string with the person's name.
#' @param excited Logical. Add exclamation marks? Default FALSE.
#'
{{#' @return A character string with the greeting.}}
#' @export
#'
#' @examples
#' greet("World")
#' greet("R User", excited = TRUE)
greet <- function(name, excited = FALSE) {
  ...
}
```

**@return** â€” What the function gives back

---

## Let's Break Down the Documentation

```{r}
#' Greet a person
#'
#' @param name A character string with the person's name.
#' @param excited Logical. Add exclamation marks? Default FALSE.
#'
#' @return A character string with the greeting.
{{#' @export}}
#'
#' @examples
#' greet("World")
#' greet("R User", excited = TRUE)
greet <- function(name, excited = FALSE) {
  ...
}
```

**@export** â€” Make this function available to users!

.warning[
Without `@export`, the function is internal only!
]

---

## Let's Break Down the Documentation

```{r}
#' Greet a person
#'
#' @param name A character string with the person's name.
#' @param excited Logical. Add exclamation marks? Default FALSE.
#'
#' @return A character string with the greeting.
#' @export
#'
{{#' @examples}}
{{#' greet("World")}}
{{#' greet("R User", excited = TRUE)}}
greet <- function(name, excited = FALSE) {
  ...
}
```

**@examples** â€” Show how to use it!

.tip[
Examples are **executable** â€” they run during `R CMD check`!
]

---

## Step 5: Document & Load

```{r}
library(devtools)

# Generate documentation
document()
```

```
â„¹ Updating mypackage documentation
â„¹ Loading mypackage
Writing NAMESPACE
Writing greet.Rd
```

--

```{r}
# Load your package for testing
load_all()

# Try it!
greet("Workshop")
#> [1] "Hello, Workshop"

greet("R", excited = TRUE)
#> [1] "Hello, R!!!"
```

---

## The Development Workflow

```{r, eval = FALSE}
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                                 â”‚
    â”‚   1. Edit code in R/                            â”‚
    â”‚          â”‚                                      â”‚
    â”‚          â–¼                                      â”‚
    â”‚   2. document()  â”€â”€â”€ generates man/ & NAMESPACE â”‚
    â”‚          â”‚                                      â”‚
    â”‚          â–¼                                      â”‚
    â”‚   3. load_all()  â”€â”€â”€ loads package for testing  â”‚
    â”‚          â”‚                                      â”‚
    â”‚          â–¼                                      â”‚
    â”‚   4. Test interactively                         â”‚
    â”‚          â”‚                                      â”‚
    â”‚          â–¼                                      â”‚
    â”‚   5. Repeat! â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚                                                 â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

.tip[
**Keyboard shortcuts:**
- `Ctrl/Cmd + Shift + D` = document()
- `Ctrl/Cmd + Shift + L` = load_all()
]

---

class: inverse, center, middle

# Part 4: Documentation Deep Dive

## Because `?your_function` should actually help!

![](https://media.giphy.com/media/WoWm8YzFQJg5i/giphy.gif)

---

## Documentation Philosophy

```{r, eval = FALSE}
                       always
                       âŠ‚_ãƒ½
                       ã€€ ï¼¼ï¼¼   document
                       ã€€ã€€ ï¼¼( Í¡Â° ÍœÊ– Í¡Â°)
                        ã€€ã€€ã€€ >ã€€âŒ’ãƒ½
                       ã€€ã€€ã€€/ ã€€ ã¸ï¼¼
                       ã€€ã€€ /ã€€ã€€/ã€€ï¼¼ï¼¼your
                       ã€€ã€€ ï¾šã€€ãƒã€€ã€€ ãƒ½_ã¤
                       ã€€ã€€/ã€€/
                       ã€€ /ã€€/|
                       ã€€(ã€€(ãƒ½
                       ã€€|ã€€|ã€ï¼¼functions
                       ã€€| ä¸¿ ï¼¼ âŒ’)
                       ã€€| |ã€€ã€€) /
                       ãƒ )ã€€ã€€Lï¾‰
                       (_ï¼
```

---

## Why Documentation Matters

> "Documentation is one of the most important aspects of good code. Without it, users won't know how to use your package, and are unlikely to do so."
>
> â€” Hadley Wickham

--

### Good documentation answers:

1. **What** does this function do?
2. **Why** would I use it?
3. **How** do I use it?
4. **What** do I get back?

---

## roxygen2 Tags Reference

| Tag | Purpose | Required? |
|-----|---------|-----------|
| `@param` | Document arguments | Yes (for each arg) |
| `@return` | Describe output | Yes |
| `@export` | Make public | If user-facing |
| `@examples` | Usage examples | Highly recommended |
| `@importFrom` | Import functions | When needed |
| `@seealso` | Related functions | Helpful |
| `@details` | Extended description | For complex functions |
| `@section` | Custom sections | Optional |
| `@family` | Group related functions | Nice to have |

---

## Complete Documentation Example

.small-code[
```{r}
#' Calculate summary statistics
#'
#' Computes common summary statistics for a numeric vector,
#' including mean, median, standard deviation, and range.
#'
#' @param x A numeric vector.
#' @param na.rm Logical. Should NA values be removed? Default `TRUE`.
#' @param digits Integer. Number of decimal places. Default 2.
#'
#' @return A named list with components:
#' \describe{
#'   \item{mean}{Arithmetic mean}
#'   \item{median}{Median value}
#'   \item{sd}{Standard deviation}
#'   \item{range}{Vector of min and max}
#' }
#'
#' @export
#'
#' @examples
#' x <- c(1, 2, 3, 4, 5, NA)
#' summarize_stats(x)
#' summarize_stats(x, digits = 4)
#'
#' @seealso [mean()], [sd()] for individual statistics
summarize_stats <- function(x, na.rm = TRUE, digits = 2) {
  list(
    mean = round(mean(x, na.rm = na.rm), digits),
    median = round(median(x, na.rm = na.rm), digits),
    sd = round(sd(x, na.rm = na.rm), digits),
    range = round(range(x, na.rm = na.rm), digits)
  )
}
```
]

---

## Using Other Packages

### Option 1: `package::function()` (Explicit)

```{r}
#' Process data
#' @export
process_data <- function(data) {
{{ dplyr::filter(data, !is.na(value)) %>%}}
{{   dplyr::mutate(log_value = log(value))}}
}
```

.tip[
Clear where each function comes from. Preferred for occasional use.
]

--

### Option 2: `@importFrom` (Cleaner code)

```{r}
{{#' @importFrom dplyr filter mutate %>%}}
#' @export
process_data <- function(data) {
  filter(data, !is.na(value)) %>%
    mutate(log_value = log(value))
}
```

.tip[
Cleaner code, but need to remember to import.
]

---

## The Pipe: Special Case

### Add pipe to your package

```{r}
# Run this once
use_pipe()
```

This creates `R/utils-pipe.R`:

```{r}
#' Pipe operator
#'
#' @name %>%
#' @rdname pipe
#' @keywords internal
#' @export
#' @importFrom magrittr %>%
#' @usage lhs \%>\% rhs
NULL
```

Now `%>%` works in your package AND users can use it!

---

## Data Documentation

### Include datasets in your package

```{r}
# Save data to data/ folder
use_data(my_dataset)
```

### Document it

```{r}
#' Sample survey data
#'
#' A dataset containing simulated survey responses.
#'
#' @format A data frame with 500 rows and 5 variables:
#' \describe{
#'   \item{id}{Respondent ID}
#'   \item{age}{Age in years}
#'   \item{satisfaction}{Satisfaction score (1-5)}
#'   \item{department}{Department name}
#'   \item{date}{Survey date}
#' }
#' @source Simulated data for demonstration purposes.
"my_dataset"
```

Save this as `R/data.R`.

---

class: inverse, center, middle

# Part 5: Testing with testthat

## Because "it works on my machine" isn't good enough

![](https://media.giphy.com/media/QMHoU66sBXqqLqYvGO/giphy.gif)

---

## Why Test?

```{r, eval = FALSE}
    ï¼œâŒ’ï¼ãƒ½-ï½¤ï¼¿
    ï¼ï¼œ_/ï¼¿ï¼¿ï¼¿ï¼¿ï¼
    
    
    'I cant sleep if you dont test your functions'
    ã€€ã€€ã€€âˆ§_âˆ§
    ã€€ã€€ (ã€€ï½¥Ï‰ï½¥)ã€€
    ã€€ ï¼¿|ã€€âŠƒï¼(ï¼¿ï¼¿_
    ï¼ã€€â””-(ï¼¿ï¼¿ï¼¿_ï¼
    ï¿£ï¿£ï¿£ï¿£ï¿£ï¿£ï¿£
```

---

## Why Test?

.pull-left[
### Without tests ğŸ˜°

- "Did I break something?"
- Fear of refactoring
- Manual checking every time
- Bugs in production
- 3 AM debugging sessions
]

.pull-right[
### With tests ğŸ˜Œ

- Confidence in changes
- Safe refactoring
- Automated verification
- Catch bugs early
- Sleep peacefully
]

--

<br>

.key-point[
Tests are **automated proof** that your code works correctly.
]

---

## Setting Up testthat

```{r}
# Run once to set up testing infrastructure
use_testthat()
```

Creates:
```
tests/
â”œâ”€â”€ testthat.R      # Test runner
â””â”€â”€ testthat/       # Your test files go here
```

--

### Create a test file

```{r}
# Creates tests/testthat/test-greeting.R
use_test("greeting")
```

---

## Anatomy of a Test

```{r}
test_that("greet returns correct greeting", {
  expect_equal(greet("World"), "Hello, World")
})
```

--

.pull-left[
### `test_that()`

- **First argument**: Description of what you're testing
- **Second argument**: Code block with expectations

```{r}
test_that("description", {
  # expectations go here
})
```
]

.pull-right[
### `expect_*()`

Assertions about your code:

| Function | Checks |
|----------|--------|
| `expect_equal()` | Values equal |
| `expect_true()` | TRUE |
| `expect_false()` | FALSE |
| `expect_error()` | Error thrown |
| `expect_warning()` | Warning thrown |
| `expect_length()` | Correct length |
]

---

## Testing Our `greet()` Function

```{r}
test_that("greet returns correct greeting", {
  # Basic case
  expect_equal(greet("World"), "Hello, World")
  
  # With excitement
  expect_equal(greet("R", excited = TRUE), "Hello, R!!!")
  
  # Default is not excited
  expect_equal(greet("Test"), "Hello, Test")
})

test_that("greet handles edge cases", {
  # Empty string
  expect_equal(greet(""), "Hello, ")
  
  # Numbers coerced to character
  expect_equal(greet(42), "Hello, 42")
})

test_that("greet returns character", {
  result <- greet("Test")
  expect_type(result, "character")
  expect_length(result, 1)
})
```

---

## Running Tests

```{r}
# Run all tests
test()
```

```
â„¹ Testing mypackage
âœ” | F W S  OK | Context
âœ” |         3 | greeting
â•â• Results â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
[ FAIL 0 | WARN 0 | SKIP 0 | PASS 3 ]

ğŸ‰ All tests passed!
```

--

### Or test interactively

```{r}
# Run tests in current file
test_active_file()

# Run a specific test file
test_file("tests/testthat/test-greeting.R")
```

---

## Test-Driven Development (TDD)

### Write the test FIRST, then the code

```{r, eval = FALSE}
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                          â”‚
    â”‚   1. Write a failing test ğŸ”´             â”‚
    â”‚          â”‚                               â”‚
    â”‚          â–¼                               â”‚
    â”‚   2. Write minimal code to pass ğŸŸ¢       â”‚
    â”‚          â”‚                               â”‚
    â”‚          â–¼                               â”‚
    â”‚   3. Refactor & improve ğŸ”µ               â”‚
    â”‚          â”‚                               â”‚
    â”‚          â–¼                               â”‚
    â”‚   4. Repeat! â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚                                          â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

--

.tip[
TDD forces you to think about **what** your function should do before **how** to implement it.
]

---

## Testing Errors

```{r}
#' Divide two numbers
#' @param x Numerator
#' @param y Denominator
#' @return x divided by y
#' @export
divide <- function(x, y) {
  if (y == 0) {
    stop("Cannot divide by zero!")
  }
  x / y
}
```

```{r}
test_that("divide handles division by zero", {
{{ expect_error(divide(10, 0), "Cannot divide by zero")}}
})

test_that("divide works correctly", {
  expect_equal(divide(10, 2), 5)
  expect_equal(divide(9, 3), 3)
})
```

---

## Snapshot Tests

### For complex outputs that are hard to specify

```{r}
test_that("summary output is correct", {
{{ expect_snapshot(summarize_stats(1:100))}}
})
```

First run creates `tests/testthat/_snaps/test-name.md`:

```
# summary output is correct

    Code
      summarize_stats(1:100)
    Output
      $mean
      [1] 50.5
      
      $median
      [1] 50.5
      ...
```

Future runs compare against this snapshot!

---

## Code Coverage

### How much of your code is tested?

```{r}
# Install covr
install.packages("covr")

# Check coverage
covr::package_coverage()
```

```
mypackage Coverage: 85.71%
R/greeting.R: 100.00%
R/divide.R: 75.00%
```

--

.tip[
Aim for 80%+ coverage, but don't obsess. **Quality > Quantity**.

Test the important paths, edge cases, and error handling.
]

---

class: inverse, center, middle

# Part 6: Checking & Sharing

## Getting Your Package Out There

![](https://media.giphy.com/media/Is1O1TWV0LEJi/giphy.gif)

---

## R CMD check

### The ultimate package validator

```{r}
# Run comprehensive checks
check()
```

Checks for:
- Documentation completeness
- Code errors and warnings
- Test failures
- DESCRIPTION validity
- NAMESPACE correctness
- Examples that work
- Cross-platform compatibility

--

.key-point[
**Goal:** 0 errors, 0 warnings, 0 notes

(Notes are sometimes acceptable, but minimize them!)
]

---
## Check Output

```
â”€â”€ R CMD check results â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ mypackage 0.1.0 â”€â”€â”€â”€
Duration: 24.5s

0 errors âœ” | 0 warnings âœ” | 0 notes âœ”
```

.center[
### ğŸ‰ The sweet taste of success! ğŸ‰

![](https://media.giphy.com/media/l0MYt5jPR6QX5pnqM/giphy.gif)
]

---

## Creating a README

```{r}
# Create README.Rmd (editable) -> README.md (for GitHub)
use_readme_rmd()
```

### Good README structure:

1. **Package name & badges**
2. **What it does** (1-2 sentences)
3. **Installation instructions**
4. **Quick example**
5. **Links to documentation**

--

```{r}
# After editing README.Rmd, regenerate README.md
build_readme()
```

---

## Adding Badges

```{r}
# R CMD check status
use_github_actions()

# Code coverage
use_github_action("test-coverage")

# CRAN badge (if on CRAN)
use_cran_badge()

# Lifecycle badge
use_lifecycle_badge("experimental")  # or stable, maturing, etc.
```

Your README gets fancy badges! ğŸ…

```
[![R-CMD-check](https://github.com/user/pkg/workflows/R-CMD-check/badge.svg)]
[![Codecov](https://codecov.io/gh/user/pkg/branch/main/graph/badge.svg)]
```

---

## pkgdown: Beautiful Documentation Sites

```{r}
# Set up pkgdown
use_pkgdown()

# Build the site
pkgdown::build_site()
```

--

Creates a professional website with:
- Function reference
- Vignettes as articles
- News/changelog
- Search functionality

--

### Deploy to GitHub Pages

```{r}
use_pkgdown_github_pages()
```

Your docs live at: `https://username.github.io/packagename/`

---

## Vignettes: Long-Form Documentation

```{r}
# Create a vignette
use_vignette("getting-started")
```

```yaml
---
title: "Getting Started with mypackage"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Getting Started with mypackage}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
```

--

Vignettes are **tutorials** showing:
- Workflows
- Use cases
- Integration with other packages
- Best practices

---

## Continuous Integration with GitHub Actions

```{r}
# Standard R CMD check on multiple platforms
use_github_actions()
```

Creates `.github/workflows/R-CMD-check.yaml`

Every push/PR automatically:
- Checks on Windows, Mac, Linux
- Tests on multiple R versions
- Reports status

--

.key-point[
CI catches issues **before** they reach users.
"Works on my machine" â†’ "Works everywhere"
]

---

## Version Numbers

### Semantic Versioning: MAJOR.MINOR.PATCH

| Version | When to Bump |
|---------|--------------|
| **0.1.0** â†’ **0.2.0** | New features (backward compatible) |
| **0.2.0** â†’ **0.2.1** | Bug fixes only |
| **0.9.0** â†’ **1.0.0** | Stable release, public API |
| **1.0.0** â†’ **2.0.0** | Breaking changes |

--

### Development versions

```r
# In DESCRIPTION
Version: 0.1.0.9000
```

The `.9000` suffix indicates development version.

---

## CRAN Submission (Optional)

### Requirements:

1. âœ… Pass `R CMD check` with 0 errors, 0 warnings, minimal notes
2. âœ… Documentation complete
3. âœ… Examples run without errors
4. âœ… Tests pass
5. âœ… No copyrighted content
6. âœ… cran-comments.md explains any notes

--

### Submit:

```{r}
# Final check as CRAN would run it
devtools::check(remote = TRUE, manual = TRUE)

# Submit to CRAN
devtools::release()
```

---

class: inverse, center, middle

# Best Practices & Tips

## Lessons Learned

![](https://media.giphy.com/media/3o7btNhMBytxAM6YBa/giphy.gif)

---

## Function Naming Conventions

### Use a consistent prefix

.pull-left[
**stringr** â€” all start with `str_`
```r
str_detect()
str_replace()
str_split()
str_trim()
```

**dplyr** â€” verbs
```r
filter()
mutate()
select()
arrange()
```
]

.pull-right[
**Your package** â€” pick a pattern!
```r
# Object prefix
mydata_clean()
mydata_transform()
mydata_export()

# Or action prefix
process_data()
process_text()
process_image()
```
]

--

.tip[
Consistent naming helps with:
- Autocomplete discovery
- Namespace clarity
- User mental model
]

---

## Error Messages That Help

.pull-left[
### âŒ Unhelpful

```{r}
if (is.null(x)) {
  stop("Error")
}
```

"Error in my_function() : Error"

ğŸ˜• What went wrong?
]

.pull-right[
### âœ… Helpful

```{r}
if (is.null(x)) {
  stop("`x` must not be NULL. ",
       "Please provide a valid input.",
       call. = FALSE)
}
```

"Error: `x` must not be NULL. Please provide a valid input."

ğŸ˜Š Clear problem and solution!
]

--

### Use `cli` for beautiful messages

```{r}
cli::cli_abort(c(
  "x" = "`x` must not be NULL.",
  "i" = "Please provide a numeric vector."
))
```

---

## Internal vs. Exported Functions

```{r}
#' Public function (users see this)
#' @export
public_function <- function(x) {
  result <- helper_function(x)
  format_output(result)
}

# Internal helper (no @export, no docs needed)
helper_function <- function(x) {
  # Complex internal logic
  x * 2
}

# Internal formatter
format_output <- function(x) {
  round(x, 2)
}
```

--

.tip[
**Export less!** A smaller public API is:
- Easier to maintain
- Less documentation to write
- More flexible to change internals
]

---

## Package Development Checklist

.pull-left[
### Before First Release

- [ ] `R CMD check` passes
- [ ] Documentation complete
- [ ] README with examples
- [ ] At least one vignette
- [ ] LICENSE file
- [ ] Tests for key functions
- [ ] pkgdown site (optional but nice)
]

.pull-right[
### Ongoing

- [ ] Run `check()` before commits
- [ ] Update NEWS.md for changes
- [ ] Bump version appropriately
- [ ] Keep dependencies minimal
- [ ] Respond to issues
- [ ] Consider CRAN submission
]

---

## Common Mistakes & Fixes

| Mistake | Fix |
|---------|-----|
| Using `library()` in package code | Use `@importFrom` or `pkg::fun()` |
| Forgetting `@export` | Add to documentation |
| Examples that fail | Use `\dontrun{}` for problematic examples |
| Missing dependencies | Add to `Imports` in DESCRIPTION |
| Tests depend on external state | Mock or skip appropriately |
| Massive dependencies | Use `Suggests` when possible |

---

## Resources

.pull-left[
### Books & Guides

- ğŸ“š [R Packages (2e)](https://r-pkgs.org/) â€” Hadley Wickham
- ğŸ“– [rOpenSci Dev Guide](https://devguide.ropensci.org/)
- ğŸ“ [Writing R Extensions](https://cran.r-project.org/doc/manuals/r-release/R-exts.html)

### Packages

- `usethis` â€” Setup automation
- `devtools` â€” Development workflow
- `roxygen2` â€” Documentation
- `testthat` â€” Testing
- `pkgdown` â€” Documentation sites
]

.pull-right[
### Cheatsheets

- [Package Development Cheatsheet](https://rawgit.com/rstudio/cheatsheets/master/package-development.pdf)

### Community

- [RStudio Community](https://community.rstudio.com/)
- [R-pkg-devel mailing list](https://stat.ethz.ch/mailman/listinfo/r-package-devel)
- [rOpenSci](https://ropensci.org/)

### Example Packages

Browse source code of your favorite packages on GitHub!
]

---

class: inverse, center, middle

# Exercises!

## Time to Build Your Own Package

---

## Exercise 1: Create Your Package

1. Choose a name (check with `available`)
2. Run `create_tidy_package()`
3. Run `use_git()` and `use_github()`

```{r}
library(usethis)
available::available("myawesomepkg")
create_tidy_package("~/projects/myawesomepkg")
use_git()
use_github()
```

---

## Exercise 2: Add a Function

Create a function that does something useful to you!

Ideas:
- A ggplot theme
- A data cleaning helper
- A formatting function
- A calculation you do often

```{r}
use_r("my_function")
```

Don't forget documentation!

---

## Exercise 3: Write Tests

```{r}
use_test("my_function")
```

Write at least 3 tests:
1. Normal case works
2. Edge case handled
3. Error case handled

```{r}
test_that("my_function works correctly", {
  expect_equal(my_function(input), expected_output)
})
```

---

## Exercise 4: Check & Document

```{r}
# Generate documentation
document()

# Run all checks
check()
```

Fix any errors or warnings!

---

## Exercise 5: Polish & Share

1. Edit README.Rmd
2. Build README: `build_readme()`
3. Optional: `use_pkgdown()` and `build_site()`
4. Push to GitHub
5. Test installation: `pak::pak("yourusername/yourpackage")`

---

class: inverse, center, middle

# You Did It!

## You're Now an R Package Developer! ğŸ‰

![](https://media.giphy.com/media/3oz8xIsloV7zOmt81G/giphy.gif)

---

## Quick Reference

.small-code[
```r
# Setup
create_tidy_package("path")    # Create new package
use_r("name")                  # Create R file
use_test("name")               # Create test file
use_data(object)               # Add dataset
use_vignette("name")           # Create vignette

# Development cycle
document()                     # Generate docs
load_all()                     # Load package
test()                         # Run tests
check()                        # Full R CMD check

# Git/GitHub
use_git()                      # Initialize git
use_github()                   # Create GitHub repo
use_github_actions()           # Add CI

# Dependencies
use_package("pkg")             # Add to Imports
use_pipe()                     # Add %>%

# Documentation
use_readme_rmd()               # Create README
use_pkgdown()                  # Setup pkgdown site
build_site()                   # Build pkgdown site
```
]

---

class: inverse, center, middle

# Thank You!

### Days 1-2: Build Dashboards with dashboardr
### Day 3: Package Your Code for the World

<br>

.fivty[
"The best time to create a package was when you copy-pasted that function the third time. The second best time is now."
]

<br>

Questions? ğŸ™‹

---

## Appendix: Key roxygen2 Tags

.tiny-code[
```
@param name Description    # Document arguments
@return Description        # What function returns  
@export                    # Make public
@examples                  # Runnable examples
@importFrom pkg fun        # Import specific function
@import pkg                # Import whole package (use sparingly)
@seealso [function()]      # Related functions
@details                   # Extended description
@section Title:            # Custom section
@family name               # Group related functions
@inheritParams function    # Copy params from another function
@rdname name               # Combine docs for multiple functions
@keywords internal         # Mark as internal (not indexed)
@noRd                      # No .Rd file generated
```
]

---

## Appendix: testthat Expectations

.tiny-code[
```r
# Equality
expect_equal(x, y)           # x equals y (with tolerance)
expect_identical(x, y)       # x exactly equals y
expect_equivalent(x, y)      # x equals y (ignoring attributes)

# Type/class
expect_type(x, "character")  # typeof(x) == "character"
expect_s3_class(x, "data.frame")
expect_s4_class(x, "MyClass")

# Logic
expect_true(x)               # x is TRUE
expect_false(x)              # x is FALSE
expect_null(x)               # x is NULL

# Errors/warnings
expect_error(f(), "message") # f() throws error matching "message"
expect_warning(f())          # f() throws warning
expect_message(f())          # f() prints message
expect_silent(f())           # f() produces no output

# Collections
expect_length(x, n)          # length(x) == n
expect_named(x, c("a", "b")) # names match
expect_contains(x, y)        # x contains y

# Comparison
expect_lt(x, y)              # x < y
expect_lte(x, y)             # x <= y
expect_gt(x, y)              # x > y
expect_gte(x, y)             # x >= y
```
]

---

## Appendix: devtools Functions

.tiny-code[
```r
# Loading
load_all()                   # Load package for testing
unload()                     # Unload package

# Documentation  
document()                   # Generate man/ and NAMESPACE
build_readme()               # Render README.Rmd

# Testing
test()                       # Run all tests
test_active_file()           # Test current file
test_coverage()              # Check code coverage

# Checking
check()                      # Full R CMD check
check_man()                  # Check documentation only
spell_check()                # Check spelling

# Building
build()                      # Build package tarball
install()                    # Install locally

# Releasing
release()                    # Submit to CRAN
submit_cran()                # Submit to CRAN (alternative)

# Vignettes
build_vignettes()            # Build all vignettes
```
]
